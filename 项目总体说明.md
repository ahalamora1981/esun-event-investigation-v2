# 项目总体说明

## 项目概述

本系统是一个事件调查分析平台，用于自动检索、评分和分析与特定交易事件相关的通信记录。系统通过多维度评估通信记录与事件的关联性，并自动识别潜在风险，为事件调查提供数据支持。

## 核心功能

### 1. 通信记录检索
系统支持从以下四种渠道检索通信记录：
- **通话记录（CALL）** - 电话通话录音和记录
- **邮件记录（EMAIL）** - 邮件往来记录
- **QTrade记录（QTRADE）** - QTrade即时通讯记录
- **Ideal记录（IDEAL）** - Ideal即时通讯记录

### 2. 相关性评分
系统从三个维度评估每条通信记录与目标事件的关联度：

| 评分维度 | 权重 | 计算方法 |
|---------|------|---------|
| **时间相关性** | 30% | 根据记录发生时间与事件时间的距离计算，每小时扣减20分 |
| **用户相关性** | 30% | 匹配记录中的用户ID/姓名与事件的内外部用户，匹配则100分 |
| **内容相关性** | 40% | 使用Reranker模型分析记录内容与事件名称的语义相关性（0-100分） |

**综合得分计算公式：**
```
综合得分 = (时间得分 × 30% + 用户得分 × 30% + 内容得分 × 40%) × 渠道权重
```

所有渠道的权重均为95分（满分100分）。

### 3. 记录筛选与排序
- 筛选综合得分≥50分的记录
- 按记录开始时间升序排列

### 4. 风险评估
对筛选后的每条记录，使用大语言模型（LLM）进行风险分析，输出：
- **风险等级**：高/中/低
- **风险描述**：详细说明风险类型、影响范围及可能的后果

### 5. 结果展示
以表格形式输出分析结果，包含：
- 编号、时间、渠道、内部用户、外部用户
- 三个维度的相关性得分
- 综合得分
- 风险等级和风险描述

## 技术架构

### 技术栈
- **编程语言**：Python 3.12+
- **包管理**：uv
- **异步框架**：asyncio
- **日志系统**：loguru
- **终端输出**：rich（表格格式化）
- **数据验证**：pydantic

### 外部服务
| 服务 | 用途 |
|-----|------|
| **CCS API** | 获取通信记录数据 |
| **Reranker服务** | 内容相关性评分 |
| **Dashscope/VLLM** | LLM模型，用于风险评估 |

### 项目结构
```
src/
├── score_records.py       # 主程序 - 事件评分与分析逻辑
├── records/                # 通信记录获取模块
│   ├── auth.py            # CCS认证令牌管理
│   ├── content.py         # 记录内容获取
│   ├── email.py           # 邮件记录检索
│   ├── call_recording.py  # 通话记录检索
│   ├── qtrade.py          # QTrade记录检索
│   └── ideal.py           # Ideal记录检索
├── utils/                  # 工具模块
│   ├── config.py          # 配置管理（TOML）
│   ├── config.toml        # 应用配置文件
│   ├── logger.py          # 日志配置
│   └── llm.py             # LLM客户端初始化
└── logs/                   # 日志文件目录（按日轮转）
```

## 数据流程

```
1. 事件定义
   ├─ 事件名称（如：230205（23 国开 205））
   ├─ 事件时间
   ├─ 内部用户ID列表
   └─ 外部用户姓名列表

2. 记录检索
   ├─ 调用CCS API获取指定时间段内的通信记录
   ├─ 包含通话、邮件、QTrade、Ideal四类记录
   └─ 检索记录的详细内容

3. 相关性评分
   ├─ 计算每条记录的时间得分
   ├─ 计算每条记录的用户得分
   ├─ 调用Reranker服务计算内容得分
   └─ 计算综合得分

4. 筛选排序
   ├─ 过滤得分≥50的记录
   └─ 按时间排序

5. 风险评估
   ├─ 调用LLM分析每条记录的风险
   └─ 输出风险等级和描述

6. 结果输出
   └─ 以表格形式展示分析结果
```

## 使用说明

### 环境要求
- Python 3.12 或更高版本
- uv包管理器

### 安装依赖
```bash
uv sync
```

### 运行主程序
```bash
python src/score_records.py
```

### 配置说明
应用配置文件位于 `src/utils/config.toml`，包含：
- CCS服务器配置（API地址、认证信息）
- Reranker服务配置（URL、模型、阈值）
- Dashscope配置（模型参数）

### 自定义事件
在 `src/score_records.py` 的 `main()` 函数中修改 `Event` 对象参数：
- `event_name`：事件名称
- `event_time`：事件发生时间
- `internal_users`：内部用户ID列表
- `external_users`：外部用户姓名列表

### 自定义查询范围
在 `src/score_records.py` 的 `get_records()` 函数中修改：
- `PARTICIPANT_IDS`：参与人ID（逗号分隔）
- `START_TIME`：查询开始时间
- `END_TIME`：查询结束时间

## 关键参数

### 评分参数
| 参数 | 值 | 说明 |
|-----|-----|------|
| `DEDUCT_PER_HOUR` | 20 | 每小时扣减的分数 |
| `BEFORE_RATE` | 1 | 事后通信衰减系数 |
| `AFTER_RATE` | 2 | 事前通信衰减系数 |
| `WEIGHT_TIME` | 30 | 时间权重 |
| `WEIGHT_USER` | 30 | 用户权重 |
| `WEIGHT_CONTENT` | 40 | 内容权重 |
| `THRESHOLD_TOTAL_SCORE` | 50 | 综合得分筛选阈值 |

### 渠道权重
```
WEIGHT_CHANNELS = {
    "CALL": 95,
    "EMAIL": 95,
    "QTRADE": 95,
    "IDEAL": 95
}
```

## 输出示例

运行完成后，控制台输出表格格式结果：

```
事件名称: 230205（23 国开 205）
事件时间: 2026-01-19T14:00:00
内部用户: ['1772917751770292225']
外部用户: ['韩梅梅', '周子航']

┏━━━━┳━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┓
┃编号┃ 时间     ┃ 渠道    ┃ 内部用户 ┃ 外部用户 ┃ 时间相关性 ┃ 用户相关性 ┃ 内容相关性 ┃ 总体相关性 ┃ 风险等级 ┃ 风险描述               ┃
┡━━━━╇━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 01 │ 14:00:00 │ EMAIL   │ 黄金     │ 韩梅梅   │ 100        │ 100        │ 95         │ 95         │ 高       │ 涉及违规信息传递...   │
└────┴──────────┴─────────┴──────────┴──────────┴────────────┴────────────┴────────────┴────────────┴──────────┴────────────────────────┘
[OK] 所有记录获取成功, 记录数: 1
[OK] 总耗时: 12.34 seconds
```

## 注意事项

1. 认证令牌有效期为1小时，系统自动缓存
2. 日志文件按日轮转，保留30天
3. API请求失败会抛出异常，需检查网络和配置
4. 时间格式支持ISO（`T`分隔）和空格分隔两种格式
5. 用户映射需在代码中维护 `USER_MAPPING` 字典
