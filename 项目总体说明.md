# 项目总体说明

## 项目概述

事件调查分析平台，自动检索、评分和分析与特定交易事件相关的通信记录。支持命令行和 Web API 两种使用方式，通过多维度评估记录与事件的关联性，自动识别潜在风险。

## 核心功能

### 1. 通信记录检索
支持五种渠道：
- 通话记录（CALL）
- 邮件记录（EMAIL）
- QTrade 记录（QTRADE）
- Ideal 记录（IDEAL）
- 交易电话记录（TRADING）

### 2. 相关性评分
三维度评估（权重：时间 30%、用户 30%、内容 40%）：
- **时间相关性**：记录时间与事件时间距离
- **用户相关性**：匹配内外部用户
- **内容相关性**：Reranker 模型分析语义关联

综合得分 ≥ 50 分的记录保留。

### 3. 风险评估
使用 LLM 分析每条记录，输出风险等级（高/中/低）和风险描述。

### 4. Web API
提供 RESTful 接口：
- `POST /reconstruct` - 事件重构
- 返回 JSON 格式结果
- 自动保存到文件

## 技术架构

### 技术栈
- Python 3.12+
- uv 包管理
- FastAPI + Uvicorn
- asyncio 异步处理
- loguru 日志
- pydantic 数据验证
- requests HTTP 客户端

### 外部服务
| 服务 | 用途 |
|-----|------|
| CCS API | 获取通信记录 |
| Reranker | 内容相关性评分 |
| Dashscope/VLLM | LLM 风险评估 |

### 项目结构
```
src/
├── score/score_records.py   # 评分与分析逻辑
├── records/                  # 记录检索
│   ├── auth.py              # CCS 认证
│   ├── content.py           # 内容获取
│   ├── email.py             # 邮件
│   ├── call_recording.py    # 通话
│   ├── qtrade.py            # QTrade
│   ├── ideal.py             # Ideal
│   └── trading_recording.py # 交易电话
├── utils/                    # 工具模块
│   ├── config.py            # 配置管理
│   ├── config.toml          # 应用配置
│   ├── logger.py            # 日志
│   └── llm.py               # LLM 客户端
├── prompts/evaluate_record_risk.md  # AI 提示词
├── output/                   # 结果输出
├── logs/                     # 日志文件
├── app.py                    # FastAPI 服务
└── test.py                   # API 测试
```

## 使用说明

### 安装依赖
```bash
uv sync
```

### 命令行模式
```bash
python src/score/score_records.py
```

### Web API 模式
```bash
uv run src/app.py
```

服务启动在 `http://localhost:8000`

### 测试 API
```bash
python src/test.py
```

或使用 curl：
```bash
curl -X POST http://localhost:8000/reconstruct \
  -H "Content-Type: application/json" \
  -d '{
    "event_name": "230205（23 国开 205）",
    "event_time": "2026-01-19T14:00:00",
    "internal_users": ["1772917751770292225"],
    "external_users": ["韩梅梅", "周子航"]
  }'
```

### 配置
配置文件：`src/utils/config.toml`
- CCS 服务器配置
- Reranker 服务配置
- Dashscope/VLLM 配置

## Docker 部署

### 构建镜像
```bash
docker-compose build
```

### 启动服务
```bash
docker-compose up -d
```

服务将在 `http://localhost:8000` 启动。

### 配置文件挂载
- `./src/utils/config.toml:/app/src/utils/config.toml:ro`
- `./src/output:/app/src/output`
- `./src/logs:/app/src/logs`

## API 接口

### POST /reconstruct
分析事件相关记录。

**请求：**
```json
{
  "event_name": "事件名称",
  "event_time": "2026-01-19T14:00:00",
  "internal_users": ["内部用户ID"],
  "external_users": ["外部用户姓名"]
}
```

**响应：**
```json
{
  "event": {
    "event_name": "事件名称",
    "event_time": "2026-01-19T14:00:00",
    "internal_users": ["ID"],
    "external_users": ["姓名"]
  },
  "records": [
    {
      "internal_user": "姓名",
      "external_user": "姓名 | null",
      "start_time": "开始时间",
      "end_time": "结束时间",
      "channel": "渠道",
      "content": "内容",
      "score": {
        "time_score": 100.0,
        "user_score": 100.0,
        "content_score": 95.0,
        "total_score": 95.0
      },
      "risk": {
        "risk_level": "高/中/低",
        "risk_description": "描述"
      }
    }
  ]
}
```

## 关键参数

### 评分参数
| 参数 | 值 | 说明 |
|-----|-----|------|
| WEIGHT_TIME | 30 | 时间权重 |
| WEIGHT_USER | 30 | 用户权重 |
| WEIGHT_CONTENT | 40 | 内容权重 |
| THRESHOLD_TOTAL_SCORE | 50 | 得分阈值 |

### 渠道权重
所有渠道权重均为 95。

## 注意事项

1. 认证令牌有效期为 1 小时，自动缓存
2. 日志按日轮转，保留 30 天
3. 时间格式支持 ISO（T 分隔）和空格分隔
4. 结果保存到 `src/output/result_YYYYMMDD_HHMMSS.json`
5. Web API 已配置 CORS，支持跨域请求
6. Docker 部署需确保配置文件正确挂载
